name: Build Ruby 2.4.3 .deb for Termux

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build in Termux Docker
        run: |
          docker run --rm -v "$PWD":/mnt ghcr.io/termux/package-builder bash -c '
            set -e
            cd /home/builder
            git clone https://github.com/termux/termux-packages.git
            cd termux-packages
            mkdir -p packages/ruby243/patches

            # Write build.sh
            printf "%s\n" \
              "TERMUX_PKG_HOMEPAGE=https://www.ruby-lang.org/" \
              "TERMUX_PKG_DESCRIPTION=\"Ruby programming language v2.4.3\"" \
              "TERMUX_PKG_LICENSE=\"BSD 2-Clause\"" \
              "TERMUX_PKG_VERSION=2.4.3" \
              "TERMUX_PKG_SRCURL=https://cache.ruby-lang.org/pub/ruby/2.4/ruby-\${TERMUX_PKG_VERSION}.tar.gz" \
              "TERMUX_PKG_SHA256=fd0375582c92045aa7d31854e724471fb469e11a4b08ff334d39052ccaaa3a98" \
              "TERMUX_PKG_DEPENDS=\"libffi, libgmp, gdbm, ncurses, readline, openssl, zlib\"" \
              "TERMUX_PKG_EXTRA_CONFIGURE_ARGS=\"--enable-shared --with-opt-dir=\$TERMUX_PREFIX --disable-install-doc\"" \
              "TERMUX_PKG_RM_AFTER_INSTALL=\"lib/ruby/2.4.0/rdoc\"" \
              "TERMUX_PKG_BUILD_IN_SRC=true" \
              > packages/ruby243/build.sh
            printf "%s\n" \
              "--- a/tool/generic_erb.rb" \
              "+++ b/tool/generic_erb.rb" \
              "@@" \
              "-#!/usr/bin/env ruby" \
              "+#!./ruby" \
              > packages/ruby243/patches/fix-generic-erb.patch
            ./build-package.sh -I ruby243
            cp -v debs/*.deb /mnt/ruby243.deb
          '

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruby_2.4.3_armv8l
          path: ruby243.deb
